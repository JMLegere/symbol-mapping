Coding instructions:
- Run `ruff check src tests` to lint code.
- Run `pytest -q` after code changes to ensure tests pass.
- Simplify and refactor any touched functions where possible.
